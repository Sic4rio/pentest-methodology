# Internal Penetration Test (Active Directory Environments)

## Unauthenticated Information Gathering

### Automated Tools
- [ ] Generate nmap output files (with targets in `targets.txt`):
    ```sh
    nmap -oA nmap-out -sV -p- -vv -iL targets.txt
    ```
- [ ] For tests with lots of web hosts, grab screenshots with a tool like [aquatone](https://github.com/michenriksen/aquatone)
- [ ] Import nmap findings into Metasploit
    ```sh
    # create a new workspace
    workspace -a <target name>
    
    # import the file
    db_import nmap-out.xml
    
    # view 5060 and 2000 to see if they are legit (they probably are not)
    services -p 5060,2000
    
    # delete them
    services -p 5060,2000 -d
    ```
- [ ] Use Metasploit modules for web dir/file enumeration
    ```sh
    msfconsole
    spool dir-scanner.txt
    use auxiliary/scanner/http/dir_scanner
    set DICTIONARY /opt/SecLists/Discovery/Web-Content/common.txt
    
    services -u -p 80 --rhosts
    set rport 80
    set ssl false
    run
    
    services -u -p 443 --rhosts
    set rport 443
    set ssl true
    run
    
    # repeat for other web ports (8443, 8080, etc)
    ```
- [ ] Check for anonymous SMB shares with `auxiliary/scanner/smb/smb_enumshares`.
- [ ] Check for open NFS shares with `auxiliary/scanner/nfs/nfsmount`.
- [ ] Check for anonymous FTP shares with `auxiliary/scanner/ftp/anonymous`.
- [ ] Create a list of machines that are not configured to do SMB signing (for relaying later on).
    ```
    nmap <ip range> --script smb-security-mode.nse -p445
    ```

### Manual Review
- [ ] Identify all URLs that allow logins.
- [ ] Manuall review screenshots from all HTTP services.


## Obtaining Credentials
- [ ] Responder attack.
    - First, run in analyze mode. Determine blue-teamy stuff and then run configure Responder.conf to not respond to those IPs.
- [ ] Execute an [ipv6 mitm](https://github.com/fox-it/mitm6) attack.
- [ ] Getting action from standard responder or mitm6? Use [Impacket](https://github.com/SecureAuthCorp/impacket)'s ntlmrelay.py to try for some interactive SMB shells.
- [ ] Start cracking any received challenge/response data.
- [ ] Wireless WPA-Enterprise attacks to gather usernames, hashes, and passwords.
    - [airgeddon](https://github.com/v1s1t0r1sh3r3/airgeddon) is a nice automation tool for hostapd-wpe.
- [ ] Internal password spray:
    - Metasploit's `auxiliary/scanner/smb/smb_login`.
    - [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec).
    


## Authenticated Information Gathering
- [ ] Manually review scripts in `\\domain_name\netlogon`
    - Don't just look for passwords - look for references to dev environments, deployment servers, etc.
- [ ] Run the [Sharphound](https://github.com/BloodHoundAD/SharpHound) injestor and map paths in Bloodhound.
- [ ] CrackMapExec tasks:
    - Enumerate shares on subnet.
    - Try to find local admin on some hosts.
    - Dump SAM (`--sam`) if you do have local admin.
    - Work to find a re-used local `Administrator` account password (--sam, pass the hash).
    - Run mimikatz module if you have admin and are ok to be noisy.


## Initial Foothold
- [ ] 

## Local Privilege Escalation
- [ ] Try [WindowsEnum](https://github.com/absolomb/WindowsEnum) or similar script to cover the basics.
- [ ] Use a test machine to observe procmon.exe for vendor 0-days (writable DLL and service paths, etc)

## Domain Privilege Escalation
- [ ] Get SPNs (Kerberoast - get that GPU humming!)
- [ ] Run [Grouper](https://github.com/l0ss/Grouper2)
- [ ] Running SQL servers? Try for authenticated SQL/SMB relay with `auxiliary/admin/mssql/mssql_ntlm_stealer`


## Objective Hunting
